/*! For license information please see ort.node.min.js.LICENSE.txt */
"use strict";var H,Ot,Lt,V,ke,Ce,Bt,Pt,_t,vt,We,Fe,he,Ie,fe,Re,Ut,Dt,At,Ne,y,A,re,g,Ge,xt,Mt,Ct,pe,Wt,je,Z,de,X,He,Ve,me,be,qe,ne,K,kt,Ze,Xe,Q,Ft,Je,Le,Ke,Qe,Ye,et,tt,we,Be,nt,ot,st,at,it,ut,ct,ft,lt,k,pt,Nt,ge,yt=Object.create,ue=Object.defineProperty,Et=Object.getOwnPropertyDescriptor,St=Object.getOwnPropertyNames,ht=Object.getPrototypeOf,It=Object.prototype.hasOwnProperty,M=(e,t)=>()=>(e&&(t=e(e=0)),t),Ae=(e,t)=>{for(var r in t)ue(e,r,{get:t[r],enumerable:!0})},ie=(e,t,r,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let o of St(t))!It.call(e,o)&&o!==r&&ue(e,o,{get:()=>t[o],enumerable:!(n=Et(t,o))||n.enumerable});return e},G=(e,t,r)=>(ie(e,t,"default"),r&&ie(r,t,"default")),Tt=(e,t,r)=>(r=null!=e?yt(ht(e)):{},ie(!t&&e&&e.__esModule?r:ue(r,"default",{value:e,enumerable:!0}),e)),xe=e=>ie(ue({},"__esModule",{value:!0}),e),ce=M(()=>{H=!!(typeof process<"u"&&process.versions&&process.versions.node)}),Se=M(()=>{ce(),Ot=H||typeof location>"u"?void 0:location.origin,V=(Lt=()=>{if(!H)return typeof document<"u"?document.currentScript?.src:typeof self<"u"?self.location?.href:void 0})(),ke=()=>{if(V&&!V.startsWith("blob:"))return V.substring(0,V.lastIndexOf("/")+1)},Ce=(e,t)=>{try{let r=t??V;return(r?new URL(e,r):new URL(e)).origin===Ot}catch{return!1}},Bt=(e,t)=>{let r=t??V;try{return(r?new URL(e,r):new URL(e)).href}catch{return}},Pt=(e,t)=>`${t??"./"}${e}`,_t=async e=>{let t=await(await fetch(e,{credentials:"same-origin"})).blob();return URL.createObjectURL(t)},vt=async e=>(await import(e)).default,We=void 0,Fe=async(e,t,r,n)=>{let o=We&&!(e||t);if(o)if(V)o=Ce(V);else{if(!n||r)throw new Error("cannot determine the script source URL.");o=!0}if(o)return[void 0,We];{let n="ort-wasm-simd-threaded.mjs",o=e??Bt(n,t),a=!H&&r&&o&&!Ce(o,t),s=a?await _t(o):o??Pt(n,t);return[a?s:void 0,await vt(s)]}}}),Y=M(()=>{Se(),Ie=!1,fe=!1,Re=!1,Ut=()=>{if(typeof SharedArrayBuffer>"u")return!1;try{return typeof MessageChannel<"u"&&(new MessageChannel).port1.postMessage(new SharedArrayBuffer(1)),WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,2,1,0,5,4,1,3,1,1,10,11,1,9,0,65,0,254,16,2,0,26,11]))}catch{return!1}},Dt=()=>{try{return WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,2,1,0,10,30,1,28,0,65,0,253,15,253,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,186,1,26,11]))}catch{return!1}},At=()=>{try{return WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,19,1,17,0,65,1,253,15,65,2,253,15,65,3,253,15,253,147,2,11]))}catch{return!1}},Ne=async e=>{if(Ie)return Promise.resolve();if(fe)throw new Error("multiple calls to 'initializeWebAssembly()' detected.");if(Re)throw new Error("previous call to 'initializeWebAssembly()' failed.");fe=!0;let t=e.initTimeout,r=e.numThreads;if(!1!==e.simd)if("relaxed"===e.simd){if(!At())throw new Error("Relaxed WebAssembly SIMD is not supported in the current environment.")}else if(!Dt())throw new Error("WebAssembly SIMD is not supported in the current environment.");let n=Ut();r>1&&!n&&(typeof self<"u"&&!self.crossOriginIsolated&&console.warn("env.wasm.numThreads is set to "+r+", but this will not work unless you enable crossOriginIsolated mode. See https://web.dev/cross-origin-isolation-guide/ for more info."),console.warn("WebAssembly multi-threading is not supported in the current environment. Falling back to single-threading."),e.numThreads=r=1);let o=e.wasmPaths,a="string"==typeof o?o:void 0,s=o?.mjs,i=s?.href??s,l=o?.wasm,u=l?.href??l,f=e.wasmBinary,[p,c]=await Fe(i,a,r>1,!!f||!!u),d=!1,w=[];if(t>0&&w.push(new Promise(e=>{setTimeout(()=>{d=!0,e()},t)})),w.push(new Promise((e,t)=>{let n={numThreads:r};if(f)n.wasmBinary=f;else if(u||a)n.locateFile=e=>u??a+e;else if(i&&0!==i.indexOf("blob:"))n.locateFile=e=>new URL(e,i).href;else if(p){let e=ke();e&&(n.locateFile=t=>e+t)}c(n).then(t=>{fe=!1,Ie=!0,he=t,e(),p&&URL.revokeObjectURL(p)},e=>{fe=!1,Re=!0,t(e)})})),await Promise.race(w),d)throw new Error(`WebAssembly backend initializing failed due to timeout: ${t}ms`)},y=()=>{if(Ie&&he)return he;throw new Error("WebAssembly is not initialized yet.")}}),le=M(()=>{Y(),A=(e,t)=>{let r=y(),n=r.lengthBytesUTF8(e)+1,o=r._malloc(n);return r.stringToUTF8(e,o,n),t.push(o),o},re=(e,t,r,n)=>{if("object"==typeof e&&null!==e){if(r.has(e))throw new Error("Circular reference in options");r.add(e)}Object.entries(e).forEach(([e,o])=>{let a=t?t+e:e;if("object"==typeof o)re(o,a+".",r,n);else if("string"==typeof o||"number"==typeof o)n(a,o.toString());else{if("boolean"!=typeof o)throw new Error("Can't handle extra config type: "+typeof o);n(a,o?"1":"0")}})},g=e=>{let t=y(),r=t.stackSave();try{let r=t.PTR_SIZE,n=t.stackAlloc(2*r);t._OrtGetLastError(n,n+r);let o=Number(t.getValue(n,4===r?"i32":"i64")),a=t.getValue(n+r,"*"),s=a?t.UTF8ToString(a):"";throw new Error(`${e} ERROR_CODE: ${o}, ERROR_MESSAGE: ${s}`)}finally{t.stackRestore(r)}}}),$e=M(()=>{Y(),le(),Ge=e=>{let t=y(),r=0,n=[],o=e||{};try{if(void 0===e?.logSeverityLevel)o.logSeverityLevel=2;else if("number"!=typeof e.logSeverityLevel||!Number.isInteger(e.logSeverityLevel)||e.logSeverityLevel<0||e.logSeverityLevel>4)throw new Error(`log severity level is not valid: ${e.logSeverityLevel}`);if(void 0===e?.logVerbosityLevel)o.logVerbosityLevel=0;else if("number"!=typeof e.logVerbosityLevel||!Number.isInteger(e.logVerbosityLevel))throw new Error(`log verbosity level is not valid: ${e.logVerbosityLevel}`);void 0===e?.terminate&&(o.terminate=!1);let a=0;return void 0!==e?.tag&&(a=A(e.tag,n)),r=t._OrtCreateRunOptions(o.logSeverityLevel,o.logVerbosityLevel,!!o.terminate,a),0===r&&g("Can't create run options."),void 0!==e?.extra&&re(e.extra,"",new WeakSet,(e,o)=>{let a=A(e,n),s=A(o,n);0!==t._OrtAddRunConfigEntry(r,a,s)&&g(`Can't set a run config entry: ${e} - ${o}.`)}),[r,n]}catch(e){throw 0!==r&&t._OrtReleaseRunOptions(r),n.forEach(e=>t._free(e)),e}}}),ze=M(()=>{Y(),le(),xt=e=>{switch(e){case"disabled":return 0;case"basic":return 1;case"extended":return 2;case"layout":return 3;case"all":return 99;default:throw new Error(`unsupported graph optimization level: ${e}`)}},Mt=e=>{switch(e){case"sequential":return 0;case"parallel":return 1;default:throw new Error(`unsupported execution mode: ${e}`)}},Ct=e=>{e.extra||(e.extra={}),e.extra.session||(e.extra.session={});let t=e.extra.session;t.use_ort_model_bytes_directly||(t.use_ort_model_bytes_directly="1"),e.executionProviders&&e.executionProviders.some(e=>"webgpu"===("string"==typeof e?e:e.name))&&(e.enableMemPattern=!1)},pe=(e,t,r,n)=>{let o=A(t,n),a=A(r,n);0!==y()._OrtAddSessionConfigEntry(e,o,a)&&g(`Can't set a session config entry: ${t} - ${r}.`)},Wt=async(e,t,r)=>{for(let n of t){let t="string"==typeof n?n:n.name,o=[];switch(t){case"webnn":if(t="WEBNN","string"!=typeof n){let t=n?.deviceType;t&&pe(e,"deviceType",t,r)}break;case"webgpu":if(t="JS","string"!=typeof n){let t=n;if(t?.preferredLayout){if("NCHW"!==t.preferredLayout&&"NHWC"!==t.preferredLayout)throw new Error(`preferredLayout must be either 'NCHW' or 'NHWC': ${t.preferredLayout}`);pe(e,"preferredLayout",t.preferredLayout,r)}}break;case"wasm":case"cpu":continue;default:throw new Error(`not supported execution provider: ${t}`)}let a=A(t,r),s=o.length,i=0,l=0;if(s>0){i=y()._malloc(s*y().PTR_SIZE),r.push(i),l=y()._malloc(s*y().PTR_SIZE),r.push(l);for(let e=0;e<s;e++)y().setValue(i+e*y().PTR_SIZE,o[e][0],"*"),y().setValue(l+e*y().PTR_SIZE,o[e][1],"*")}0!==await y()._OrtAppendExecutionProvider(e,a,i,l,s)&&g(`Can't append execution provider: ${t}.`)}},je=async e=>{let t=y(),r=0,n=[],o=e||{};Ct(o);try{let e=xt(o.graphOptimizationLevel??"all"),a=Mt(o.executionMode??"sequential"),s="string"==typeof o.logId?A(o.logId,n):0,i=o.logSeverityLevel??2;if(!Number.isInteger(i)||i<0||i>4)throw new Error(`log severity level is not valid: ${i}`);let l=o.logVerbosityLevel??0;if(!Number.isInteger(l)||l<0||l>4)throw new Error(`log verbosity level is not valid: ${l}`);let u="string"==typeof o.optimizedModelFilePath?A(o.optimizedModelFilePath,n):0;if(r=t._OrtCreateSessionOptions(e,!!o.enableCpuMemArena,!!o.enableMemPattern,a,!!o.enableProfiling,0,s,i,l,u),0===r&&g("Can't create session options."),o.executionProviders&&await Wt(r,o.executionProviders,n),void 0!==o.enableGraphCapture){if("boolean"!=typeof o.enableGraphCapture)throw new Error(`enableGraphCapture must be a boolean value: ${o.enableGraphCapture}`);pe(r,"enableGraphCapture",o.enableGraphCapture.toString(),n)}if(o.freeDimensionOverrides)for(let[e,a]of Object.entries(o.freeDimensionOverrides)){if("string"!=typeof e)throw new Error(`free dimension override name must be a string: ${e}`);if("number"!=typeof a||!Number.isInteger(a)||a<0)throw new Error(`free dimension override value must be a non-negative integer: ${a}`);let o=A(e,n);0!==t._OrtAddFreeDimensionOverride(r,o,a)&&g(`Can't set a free dimension override: ${e} - ${a}.`)}return void 0!==o.extra&&re(o.extra,"",new WeakSet,(e,t)=>{pe(r,e,t,n)}),[r,n]}catch(e){throw 0!==r&&0!==t._OrtReleaseSessionOptions(r)&&g("Can't release session options."),n.forEach(e=>t._free(e)),e}}}),Te=M(()=>{Z=e=>{switch(e){case"int8":return 3;case"uint8":return 2;case"bool":return 9;case"int16":return 5;case"uint16":return 4;case"int32":return 6;case"uint32":return 12;case"float16":return 10;case"float32":return 1;case"float64":return 11;case"string":return 8;case"int64":return 7;case"uint64":return 13;case"int4":return 22;case"uint4":return 21;default:throw new Error(`unsupported data type: ${e}`)}},de=e=>{switch(e){case 3:return"int8";case 2:return"uint8";case 9:return"bool";case 5:return"int16";case 4:return"uint16";case 6:return"int32";case 12:return"uint32";case 10:return"float16";case 1:return"float32";case 11:return"float64";case 8:return"string";case 7:return"int64";case 13:return"uint64";case 22:return"int4";case 21:return"uint4";default:throw new Error(`unsupported data type: ${e}`)}},X=(e,t)=>{let r=[-1,4,1,1,2,2,4,8,-1,1,2,8,4,8,-1,-1,-1,-1,-1,-1,-1,.5,.5][e],n="number"==typeof t?t:t.reduce((e,t)=>e*t,1);return r>0?Math.ceil(n*r):void 0},He=e=>{switch(e){case"float16":return typeof Float16Array<"u"&&Float16Array.from?Float16Array:Uint16Array;case"float32":return Float32Array;case"uint8":case"bool":return Uint8Array;case"int8":return Int8Array;case"uint16":return Uint16Array;case"int16":return Int16Array;case"int32":return Int32Array;case"float64":return Float64Array;case"uint32":return Uint32Array;case"int64":return BigInt64Array;case"uint64":return BigUint64Array;default:throw new Error(`unsupported type: ${e}`)}},Ve=e=>{switch(e){case"verbose":return 0;case"info":return 1;case"warning":return 2;case"error":return 3;case"fatal":return 4;default:throw new Error(`unsupported logging level: ${e}`)}},me=e=>"float32"===e||"float16"===e||"int32"===e||"int64"===e||"uint32"===e||"uint8"===e||"bool"===e||"uint4"===e||"int4"===e,be=e=>"float32"===e||"float16"===e||"int32"===e||"int64"===e||"uint32"===e||"uint64"===e||"int8"===e||"uint8"===e||"bool"===e||"uint4"===e||"int4"===e,qe=e=>{switch(e){case"none":return 0;case"cpu":return 1;case"cpu-pinned":return 2;case"texture":return 3;case"gpu-buffer":return 4;case"ml-tensor":return 5;default:throw new Error(`unsupported data location: ${e}`)}}}),Oe=M(()=>{ce(),ne=async e=>{if("string"!=typeof e)return e instanceof Blob?new Uint8Array(await e.arrayBuffer()):e instanceof Uint8Array?e:new Uint8Array(e);if(!H){let t=await fetch(e);if(!t.ok)throw new Error(`failed to load external data file: ${e}`);let r=t.headers.get("Content-Length"),n=r?parseInt(r,10):0;if(n<1073741824)return new Uint8Array(await t.arrayBuffer());{if(!t.body)throw new Error(`failed to load external data file: ${e}, no response body.`);let r,o=t.body.getReader();try{r=new ArrayBuffer(n)}catch(e){if(!(e instanceof RangeError))throw e;{let e=Math.ceil(n/65536);r=new WebAssembly.Memory({initial:e,maximum:e}).buffer}}let a=0;for(;;){let{done:e,value:t}=await o.read();if(e)break;let n=t.byteLength;new Uint8Array(r,a,n).set(t),a+=n}return new Uint8Array(r,0,n)}}try{let{readFile:t}=require("node:fs/promises");return new Uint8Array(await t(e))}catch(t){if("ERR_FS_FILE_TOO_LARGE"===t.code){let{createReadStream:t}=require("node:fs"),r=t(e),n=[];for await(let e of r)n.push(e);return new Uint8Array(Buffer.concat(n))}throw t}}}),rt=M(()=>{K=require("onnxruntime-common"),$e(),ze(),Te(),Y(),le(),Oe(),kt=(e,t)=>{0!==y()._OrtInit(e,t)&&g("Can't initialize onnxruntime.")},Ze=async e=>{kt(e.wasm.numThreads,Ve(e.logLevel))},Xe=async(e,t)=>{y().asyncInit?.();let r=e.webgpu.adapter;if("webgpu"===t){if(typeof navigator>"u"||!navigator.gpu)throw new Error("WebGPU is not supported in current environment");if(r){if("object"!=typeof r.limits||"object"!=typeof r.features||"function"!=typeof r.requestDevice)throw new Error("Invalid GPU adapter set in `env.webgpu.adapter`. It must be a GPUAdapter object.")}else{let t=e.webgpu.powerPreference;if(void 0!==t&&"low-power"!==t&&"high-performance"!==t)throw new Error(`Invalid powerPreference setting: "${t}"`);let n=e.webgpu.forceFallbackAdapter;if(void 0!==n&&"boolean"!=typeof n)throw new Error(`Invalid forceFallbackAdapter setting: "${n}"`);if(r=await navigator.gpu.requestAdapter({powerPreference:t,forceFallbackAdapter:n}),!r)throw new Error('Failed to get GPU adapter. You may need to enable flag "--enable-unsafe-webgpu" if you are using Chrome.')}}if("webnn"===t&&(typeof navigator>"u"||!navigator.ml))throw new Error("WebNN is not supported in current environment")},Q=new Map,Ft=e=>{let t=y(),r=t.stackSave();try{let r=t.PTR_SIZE,n=t.stackAlloc(2*r);0!==t._OrtGetInputOutputCount(e,n,n+r)&&g("Can't get session input/output count.");let o=4===r?"i32":"i64";return[Number(t.getValue(n,o)),Number(t.getValue(n+r,o))]}finally{t.stackRestore(r)}},Je=(e,t)=>{let r=y(),n=r.stackSave(),o=0;try{let n=r.PTR_SIZE,a=r.stackAlloc(2*n);0!==r._OrtGetInputOutputMetadata(e,t,a,a+n)&&g("Can't get session input/output metadata.");let s=Number(r.getValue(a,"*"));o=Number(r.getValue(a+n,"*"));let i=r.HEAP32[o/4];if(0===i)return[s,0];let l=r.HEAPU32[o/4+1],u=[];for(let e=0;e<l;e++){let t=Number(r.getValue(o+8+e*n,"*"));u.push(0!==t?r.UTF8ToString(t):Number(r.getValue(o+8+(e+l)*n,"*")))}return[s,i,u]}finally{r.stackRestore(n),0!==o&&r._OrtFree(o)}},Le=e=>{let t=y(),r=t._malloc(e.byteLength);if(0===r)throw new Error(`Can't create a session. failed to allocate a buffer of size ${e.byteLength}.`);return t.HEAPU8.set(e,r),[r,e.byteLength]},Ke=async(e,t)=>{let r,n,o=y();Array.isArray(e)?[r,n]=e:e.buffer===o.HEAPU8.buffer?[r,n]=[e.byteOffset,e.byteLength]:[r,n]=Le(e);let a=0,s=0,i=[],l=[],u=[];try{if([s,i]=await je(t),t?.externalData&&o.mountExternalData){let e=[];for(let r of t.externalData){let t="string"==typeof r?r:r.path;e.push(ne("string"==typeof r?r:r.data).then(e=>{o.mountExternalData(t,e)}))}await Promise.all(e)}for(let e of t?.executionProviders??[])if("webnn"===("string"==typeof e?e:e.name)){if(o.shouldTransferToMLTensor=!1,"string"!=typeof e){let t=e,r=t?.context,n=t?.gpuDevice,a=t?.deviceType,s=t?.powerPreference;o.currentContext=r||(n?await o.webnnCreateMLContext(n):await o.webnnCreateMLContext({deviceType:a,powerPreference:s}))}else o.currentContext=await o.webnnCreateMLContext();break}a=await o._OrtCreateSession(r,n,s),o.webgpuOnCreateSession?.(a),0===a&&g("Can't create a session."),o.jsepOnCreateSession?.(),o.currentContext&&(o.webnnRegisterMLContext(a,o.currentContext),o.currentContext=void 0,o.shouldTransferToMLTensor=!0);let[e,f]=Ft(a),p=!!t?.enableGraphCapture,c=[],d=[],w=[],y=[];for(let t=0;t<e;t++){let[e,r,n]=Je(a,t);0===e&&g("Can't get an input name."),l.push(e);let s=o.UTF8ToString(e);c.push(s),w.push(0===r?{name:s,isTensor:!1}:{name:s,isTensor:!0,type:de(r),shape:n})}for(let t=0;t<f;t++){let[r,n,s]=Je(a,t+e);0===r&&g("Can't get an output name."),u.push(r);let i=o.UTF8ToString(r);d.push(i),y.push(0===n?{name:i,isTensor:!1}:{name:i,isTensor:!0,type:de(n),shape:s})}return Q.set(a,[a,l,u,null,p,!1]),[a,c,d,w,y]}catch(e){throw l.forEach(e=>o._OrtFree(e)),u.forEach(e=>o._OrtFree(e)),0!==a&&0!==o._OrtReleaseSession(a)&&g("Can't release session."),e}finally{o._free(r),0!==s&&0!==o._OrtReleaseSessionOptions(s)&&g("Can't release session options."),i.forEach(e=>o._free(e)),o.unmountExternalData?.()}},Qe=e=>{let t=y(),r=Q.get(e);if(!r)throw new Error(`cannot release session. invalid session id: ${e}`);let[n,o,a,s,i]=r;s&&(i&&0!==t._OrtClearBoundOutputs(s.handle)&&g("Can't clear bound outputs."),0!==t._OrtReleaseBinding(s.handle)&&g("Can't release IO binding.")),t.jsepOnReleaseSession?.(e),t.webnnOnReleaseSession?.(e),t.webgpuOnReleaseSession?.(e),o.forEach(e=>t._OrtFree(e)),a.forEach(e=>t._OrtFree(e)),0!==t._OrtReleaseSession(n)&&g("Can't release session."),Q.delete(e)},Ye=async(e,t,r,n,o,a,s=!1)=>{if(!e)return void t.push(0);let i,l,u=y(),f=u.PTR_SIZE,p=e[0],c=e[1],d=e[3],w=d;if("string"===p&&("gpu-buffer"===d||"ml-tensor"===d))throw new Error("String tensor is not supported on GPU.");if(s&&"gpu-buffer"!==d)throw new Error(`External buffer must be provided for input/output index ${a} when enableGraphCapture is true.`);if("gpu-buffer"===d){let t=e[2].gpuBuffer;l=X(Z(p),c);{let e=u.jsepRegisterBuffer;if(!e)throw new Error('Tensor location "gpu-buffer" is not supported without using WebGPU.');i=e(n,a,t,l)}}else if("ml-tensor"===d){let t=e[2].mlTensor;l=X(Z(p),c);let r=u.webnnRegisterMLTensor;if(!r)throw new Error('Tensor location "ml-tensor" is not supported without using WebNN.');i=r(n,t,Z(p),c)}else{let t=e[2];if(Array.isArray(t)){l=f*t.length,i=u._malloc(l),r.push(i);for(let e=0;e<t.length;e++){if("string"!=typeof t[e])throw new TypeError(`tensor data at index ${e} is not a string`);u.setValue(i+e*f,A(t[e],r),"*")}}else{let e=u.webnnIsGraphInput,a=u.webnnIsGraphOutput;if("string"!==p&&e&&a){let s=u.UTF8ToString(o);if(e(n,s)||a(n,s)){let e=Z(p);l=X(e,c),w="ml-tensor";let r=u.webnnCreateTemporaryTensor,o=u.webnnUploadTensor;if(!r||!o)throw new Error('Tensor location "ml-tensor" is not supported without using WebNN.');let a=await r(n,e,c);o(a,new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),i=a}else l=t.byteLength,i=u._malloc(l),r.push(i),u.HEAPU8.set(new Uint8Array(t.buffer,t.byteOffset,l),i)}else l=t.byteLength,i=u._malloc(l),r.push(i),u.HEAPU8.set(new Uint8Array(t.buffer,t.byteOffset,l),i)}}let m=u.stackSave(),h=u.stackAlloc(4*c.length);try{c.forEach((e,t)=>u.setValue(h+t*f,e,4===f?"i32":"i64"));let e=u._OrtCreateTensor(Z(p),i,l,h,c.length,qe(w));0===e&&g(`Can't create tensor for input/output. session=${n}, index=${a}.`),t.push(e)}finally{u.stackRestore(m)}},et=async(e,t,r,n,o,a)=>{let s=y(),i=s.PTR_SIZE,l=Q.get(e);if(!l)throw new Error(`cannot run inference. invalid session id: ${e}`);let u=l[0],f=l[1],p=l[2],c=l[3],d=l[4],w=(l[5],t.length),m=n.length,h=0,b=[],v=[],E=[],T=[],O=s.stackSave(),A=s.stackAlloc(w*i),_=s.stackAlloc(w*i),C=s.stackAlloc(m*i),R=s.stackAlloc(m*i);try{[h,b]=Ge(a),(0,K.TRACE_EVENT_BEGIN)("wasm prepareInputOutputTensor");for(let n=0;n<w;n++)await Ye(r[n],v,T,e,f[t[n]],t[n],d);for(let t=0;t<m;t++)await Ye(o[t],E,T,e,p[n[t]],w+n[t],d);(0,K.TRACE_EVENT_END)("wasm prepareInputOutputTensor");for(let e=0;e<w;e++)s.setValue(A+e*i,v[e],"*"),s.setValue(_+e*i,f[t[e]],"*");for(let e=0;e<m;e++)s.setValue(C+e*i,E[e],"*"),s.setValue(R+e*i,p[n[e]],"*");let l;s.jsepOnRunStart?.(u),s.webnnOnRunStart?.(u),l=await s._OrtRun(u,_,A,w,R,m,C,h),0!==l&&g("failed to call OrtRun().");let y=[],O=[];(0,K.TRACE_EVENT_BEGIN)("wasm ProcessOutputTensor");for(let t=0;t<m;t++){let r=Number(s.getValue(C+t*i,"*"));if(r===E[t]){y.push(o[t]);continue}let a,l=s.stackSave(),u=s.stackAlloc(4*i),f=!1,p=0;try{0!==s._OrtGetTensorData(r,u,u+i,u+2*i,u+3*i)&&g(`Can't access output tensor data on index ${t}.`);let o=4===i?"i32":"i64",l=Number(s.getValue(u,o));p=s.getValue(u+i,"*");let d=s.getValue(u+2*i,"*"),w=Number(s.getValue(u+3*i,o)),m=[];for(let e=0;e<w;e++)m.push(Number(s.getValue(d+e*i,o)));0!==s._OrtFree(d)&&g("Can't free memory for tensor dims.");let h=m.reduce((e,t)=>e*t,1);a=de(l);let b=c?.outputPreferredLocations[n[t]];if("string"===a){if("gpu-buffer"===b||"ml-tensor"===b)throw new Error("String tensor is not supported on GPU.");let e=[];for(let t=0;t<h;t++){let r=s.getValue(p+t*i,"*"),n=s.getValue(p+(t+1)*i,"*"),o=t===h-1?void 0:n-r;e.push(s.UTF8ToString(r,o))}y.push([a,m,e,"cpu"])}else if("gpu-buffer"===b&&h>0){let e=s.jsepGetBuffer;if(!e)throw new Error('preferredLocation "gpu-buffer" is not supported without using WebGPU.');let t=e(p),n=X(l,h);if(void 0===n||!me(a))throw new Error(`Unsupported data type: ${a}`);f=!0,y.push([a,m,{gpuBuffer:t,download:s.jsepCreateDownloader(t,n,a),dispose:()=>{0!==s._OrtReleaseTensor(r)&&g("Can't release tensor.")}},"gpu-buffer"])}else if("ml-tensor"===b&&h>0){let t=s.webnnEnsureTensor,n=s.webnnIsGraphInputOutputTypeSupported;if(!t||!n)throw new Error('preferredLocation "ml-tensor" is not supported without using WebNN.');if(void 0===X(l,h)||!be(a))throw new Error(`Unsupported data type: ${a}`);if(!n(e,a,!1))throw new Error(`preferredLocation "ml-tensor" for ${a} output is not supported by current WebNN Context.`);let o=await t(e,p,l,m,!1);f=!0,y.push([a,m,{mlTensor:o,download:s.webnnCreateMLTensorDownloader(p,a),dispose:()=>{s.webnnReleaseTensorId(p),s._OrtReleaseTensor(r)}},"ml-tensor"])}else if("ml-tensor-cpu-output"===b&&h>0){let e=s.webnnCreateMLTensorDownloader(p,a)(),t=y.length;f=!0,O.push((async()=>{let n=[t,await e];return s.webnnReleaseTensorId(p),s._OrtReleaseTensor(r),n})()),y.push([a,m,[],"cpu"])}else{let e=new(He(a))(h);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(s.HEAPU8.subarray(p,p+e.byteLength)),y.push([a,m,e,"cpu"])}}finally{s.stackRestore(l),"string"===a&&p&&s._free(p),f||s._OrtReleaseTensor(r)}}c&&!d&&(0!==s._OrtClearBoundOutputs(c.handle)&&g("Can't clear bound outputs."),Q.set(e,[u,f,p,c,d,!1]));for(let[e,t]of await Promise.all(O))y[e][2]=t;return(0,K.TRACE_EVENT_END)("wasm ProcessOutputTensor"),y}finally{s.webnnOnRunEnd?.(u),s.stackRestore(O),v.forEach(e=>s._OrtReleaseTensor(e)),E.forEach(e=>s._OrtReleaseTensor(e)),T.forEach(e=>s._free(e)),0!==h&&s._OrtReleaseRunOptions(h),b.forEach(e=>s._free(e))}},tt=e=>{let t=y(),r=Q.get(e);if(!r)throw new Error("invalid session id");let n=r[0],o=t._OrtEndProfiling(n);0===o&&g("Can't get an profile file name."),t._OrtFree(o)}}),Pe=M(()=>{we=require("onnxruntime-common"),rt(),Y(),Se(),Be=!1,nt=!1,ot=!1,st=async()=>{if(!nt){if(Be)throw new Error("multiple calls to 'initWasm()' detected.");if(ot)throw new Error("previous call to 'initWasm()' failed.");Be=!0;try{await Ne(we.env.wasm),await Ze(we.env),nt=!0}catch(e){throw ot=!0,e}finally{Be=!1}}},at=async e=>{await Xe(we.env,e)},it=async e=>Le(e),ut=async(e,t)=>Ke(e,t),ct=async e=>{Qe(e)},ft=async(e,t,r,n,o,a)=>et(e,t,r,n,o,a),lt=async e=>{tt(e)}}),dt=M(()=>{k=require("onnxruntime-common"),Pe(),Te(),ce(),Oe(),pt=(e,t)=>{switch(e.location){case"cpu":return[e.type,e.dims,e.data,"cpu"];case"gpu-buffer":return[e.type,e.dims,{gpuBuffer:e.gpuBuffer},"gpu-buffer"];case"ml-tensor":return[e.type,e.dims,{mlTensor:e.mlTensor},"ml-tensor"];default:throw new Error(`invalid data location: ${e.location} for ${t()}`)}},Nt=e=>{switch(e[3]){case"cpu":return new k.Tensor(e[0],e[2],e[1]);case"gpu-buffer":{let t=e[0];if(!me(t))throw new Error(`not supported data type: ${t} for deserializing GPU tensor`);let{gpuBuffer:r,download:n,dispose:o}=e[2];return k.Tensor.fromGpuBuffer(r,{dataType:t,dims:e[1],download:n,dispose:o})}case"ml-tensor":{let t=e[0];if(!be(t))throw new Error(`not supported data type: ${t} for deserializing MLTensor tensor`);let{mlTensor:r,download:n,dispose:o}=e[2];return k.Tensor.fromMLTensor(r,{dataType:t,dims:e[1],download:n,dispose:o})}default:throw new Error(`invalid data location: ${e[3]}`)}},ge=class{async fetchModelAndCopyToWasmMemory(e){return it(await ne(e))}async loadModel(e,t){let r;(0,k.TRACE_FUNC_BEGIN)(),r="string"==typeof e?H?await ne(e):await this.fetchModelAndCopyToWasmMemory(e):e,[this.sessionId,this.inputNames,this.outputNames,this.inputMetadata,this.outputMetadata]=await ut(r,t),(0,k.TRACE_FUNC_END)()}async dispose(){return ct(this.sessionId)}async run(e,t,r){(0,k.TRACE_FUNC_BEGIN)();let n=[],o=[];Object.entries(e).forEach(e=>{let t=e[0],r=e[1],a=this.inputNames.indexOf(t);if(-1===a)throw new Error(`invalid input '${t}'`);n.push(r),o.push(a)});let a=[],s=[];Object.entries(t).forEach(e=>{let t=e[0],r=e[1],n=this.outputNames.indexOf(t);if(-1===n)throw new Error(`invalid output '${t}'`);a.push(r),s.push(n)});let i=n.map((e,t)=>pt(e,()=>`input "${this.inputNames[o[t]]}"`)),l=a.map((e,t)=>e?pt(e,()=>`output "${this.outputNames[s[t]]}"`):null),u=await ft(this.sessionId,o,i,s,l,r),f={};for(let e=0;e<u.length;e++)f[this.outputNames[s[e]]]=a[e]??Nt(u[e]);return(0,k.TRACE_FUNC_END)(),f}startProfiling(){}endProfiling(){lt(this.sessionId)}}}),bt={};Ae(bt,{OnnxruntimeWebAssemblyBackend:()=>ye,initializeFlags:()=>mt,wasmBackend:()=>Gt});var v,mt,ye,Gt,wt=M(()=>{v=require("onnxruntime-common"),Pe(),dt(),mt=()=>{("number"!=typeof v.env.wasm.initTimeout||v.env.wasm.initTimeout<0)&&(v.env.wasm.initTimeout=0);let e=v.env.wasm.simd;if("boolean"!=typeof e&&void 0!==e&&"fixed"!==e&&"relaxed"!==e&&(console.warn(`Property "env.wasm.simd" is set to unknown value "${e}". Reset it to \`false\` and ignore SIMD feature checking.`),v.env.wasm.simd=!1),"boolean"!=typeof v.env.wasm.proxy&&(v.env.wasm.proxy=!1),"boolean"!=typeof v.env.wasm.trace&&(v.env.wasm.trace=!1),"number"!=typeof v.env.wasm.numThreads||!Number.isInteger(v.env.wasm.numThreads)||v.env.wasm.numThreads<=0)if(typeof self<"u"&&!self.crossOriginIsolated)v.env.wasm.numThreads=1;else{let e=typeof navigator>"u"?require("node:os").cpus().length:navigator.hardwareConcurrency;v.env.wasm.numThreads=Math.min(4,Math.ceil((e||1)/2))}},Gt=new(ye=class{async init(e){mt(),await st(),await at(e)}async createInferenceSessionHandler(e,t){let r=new ge;return await r.loadModel(e,t),r}})}),F={};Ae(F,{default:()=>jt}),module.exports=xe(F),G(F,require("onnxruntime-common"),module.exports);var $t=Tt(require("onnxruntime-common")),oe=require("onnxruntime-common"),Me="1.23.0",jt=$t;{let e=(wt(),xe(bt)).wasmBackend;(0,oe.registerBackend)("cpu",e,10),(0,oe.registerBackend)("wasm",e,10)}Object.defineProperty(oe.env.versions,"web",{value:Me,enumerable:!0});